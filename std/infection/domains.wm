-- Stdlib-declared infection domains (MVP metadata parsing)
--
-- NOTE: These declarations are parsed by the compiler but not enforced yet.
-- They are the starting point for the "stdlib owns infection semantics" refactor.

-- ---------------------------------------------------------------------------
-- effect domain (Result-like short-circuit, row_set)
-- ---------------------------------------------------------------------------
domain effect {
  stateKind rowSet;
  merge singleton;
  mergeRow union;
  boundary mustBeCarrier;
  conflict none;
};

-- ---------------------------------------------------------------------------
-- taint domain (Tainted-like, row_set)
-- ---------------------------------------------------------------------------
domain taint {
  stateKind rowSet;
  merge singleton;
  mergeRow union;
  boundary mustBeCarrier;
  conflict none;
};

-- ---------------------------------------------------------------------------
-- mem domain (non-linear, row_bag via "unique tag keys")
-- ---------------------------------------------------------------------------
domain mem {
  stateKind rowBag;
  merge singleton;
  mergeRow bagUnion;
};

-- ---------------------------------------------------------------------------
-- hole domain (hazel mode by default)
-- ---------------------------------------------------------------------------
domain hole {
  stateKind rowSet;
  merge singleton;
  mergeRow union;
};

-- ---------------------------------------------------------------------------
-- Example op rules (MVP)
-- ---------------------------------------------------------------------------
op mem.alloc {
  domain mem;
  adds [Opened];
};

op mem.close {
  domain mem;
  target arg0;
  adds [Closed];
};

op mem.fill {
  domain mem;
  target arg0;
  requiresExact [Opened];
};

policy pure {
  rejectsAllDomains;
};

policy noLeakMem {
  domain mem;
  requireAtReturn [Closed];
};

-- ---------------------------------------------------------------------------
-- Example annotations (exercise policy plumbing)
-- ---------------------------------------------------------------------------
annotate abs { pure };
